_(documentation in progress)_

For this version of this version of the prototype, we have:  
* a Raspberry Pi connected to a battery (= "Node 1" = "consumer")
* a Raspberry Pi connected to a solar panel and a battery (= "Node 2" = "producer")
* a Raspberry Pi controlling a relay, allowing to switch the energy source

(_Schema to be added_)

On each node (_consumer_ and _producer_), the CitizenWatt application, Ethereum and the Daisee App are running.
In order to allow for energy exchange, additional python scripts are required:  
âž¡  https://github.com/DAISEE/Scripts  

## Installation
Clone the repository on each Raspberry Pi:  
```bash
$ git clone https://github.com/DAISEE/Scripts.git
```

### Relay

* After connecting the relay to the Raspberry Pi (see the tutorial on [Sunfounder Wiki](http://wiki.sunfounder.cc/index.php?title=4-Channel_High_Level_Trigger_Relay)), connect the node 1 energy source to the first channel (= _channel 0_) and the node 2 energy source to the second channel (= _channel 1_).

* Install [RPI.GPIO](https://pypi.python.org/pypi/RPi.GPIO) library:  
```bash
$ pip3 install RPi.GPIO pyyaml
```

* Run the following script:
```bash
$ python3 scripts/server_relay.py
```

The others nodes can interact with the relay through sockets (port: 15555).  

### Producer and consumer nodes

* To interact with the Ethereum blockchain, the [web3.py](https://github.com/pipermerriam/web3.py) library, a python implementation of [web3.js](https://github.com/ethereum/web3.js), is used.
```bash
$ pip3 install web3
```

* create the parameter file (`parameters.yml`) from the example and complete it:

|Type|Field|Description|
| ------------- | ------------- | ------------- |
|**contracts**|||
| |daisee| Daisee.sol address on the blockchain|
| |token| DaiseeCoin smart-contract address on the blockchain|
| |node| url of Ethereum client |
|**node**|||
| |address| Ethereum account |
| |accountpswd| Ethereum account password |
| |url| url of the monitoring application (should be the same as Ethereum client) |
| |id| id of the sensor (on the monitoring app) |
| |type | type of node ('C' for consumer, 'P' for producer). |
| |login | login for energy monitoring application |
| |password | password for energy monitoring application |
| |limit | threshold from which the exchange is triggered |
| |delta | quantity of energy to buy |
| |channel | relay channel |
| |fuelgauge | if the battery state of charge is monitored (Boolean) |
|**sellers**|||
| |seller**n**| part to duplicate, with the Ethereum account and channel of the seller (where **n** is the seller number) |
|**relay**|||
| |host| Ip of the rapsberry pi controlling the relay |
| |port| socket port (15555) |
  

_exemple:_  
```
contract:
  address: '0xc33179A7f73fCcCe0DED8e613Fcf2688bA385558'
  token: '0xdFf8C10F1E64B592cF902e82C948E2ddF9f49aaF'
  node: '192.168.0.10'
node:
  address: '0x004ec07d2329997267ec62b4166639513386f32e'
  accountpswd: 'password1'
  url: 'http://192.168.0.10:8080'
  sensorId: 1
  typ: 'C'
  login: 'user'
  password: 'password2'
  limit: 20
  delta: 200
  channel: 0
  fuelgauge: False
sellers:
  seller1:
    account: '0x00625a1a269ac76c7c7b98939b5e60916fd41070'
    channel: 1
relay:
  host: '192.168.0.50'
  port: 15555
```

## Running scripts

The script `client_interaction.py` allows to update energy data on the Blockchain from data exposed by CitizenWatt API and triggers energy exchange.

### Producer Node

Just run the script:
```bash
$ python3 scripts/client_interaction.py
```

The transactions are displayed on the DAISEE App:  
![](https://framapic.org/rF3y8mDMoZ4Q/uCZHjaCo94IA)

### Consumer Node

_(to be completed)_